@page
@model VSMS.Web.Pages.Shifts.OpenModel
@using VSMS.Core.Enums
@{
    ViewData["Title"] = "Open Shifts";
    Layout = "_Layout";
}

<h2>Open Shifts</h2>
<p class="lead">Browse available volunteer shifts and sign up to help.</p>

<div class="mb-3">
    <span class="badge shift-open p-2">Open - needs volunteer</span>
    <span class="badge shift-assigned p-2">Assigned - backup needed</span>
    <span class="badge shift-confirmed p-2">Filled</span>
</div>

@if (Model.Weeks.Any())
{
    <div class="table-responsive">
        <table class="table table-bordered">
            <thead class="table-light">
                <tr>
                    <th style="width: 14.28%">Sun</th>
                    <th style="width: 14.28%">Mon</th>
                    <th style="width: 14.28%">Tue</th>
                    <th style="width: 14.28%">Wed</th>
                    <th style="width: 14.28%">Thu</th>
                    <th style="width: 14.28%">Fri</th>
                    <th style="width: 14.28%">Sat</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var week in Model.Weeks)
                {
                    <tr>
                        @foreach (var day in week)
                        {
                            <td class="align-top p-1" style="min-height: 120px; vertical-align: top;">
                                @if (day != null)
                                {
                                    var isToday = day.Value == DateOnly.FromDateTime(DateTime.Today);
                                    <div class="fw-bold mb-1 @(isToday ? "text-primary" : "")">
                                        @day.Value.ToString("MMM d")
                                        @if (isToday)
                                        {
                                            <span class="badge bg-primary">Today</span>
                                        }
                                    </div>
                                    @foreach (var slot in Model.GetSlotsForDate(day.Value))
                                    {
                                        var isPrimary = slot.AvailableSlot == "Primary";
                                        var slotLabel = slot.AvailableSlot == "Backup1" ? "B1" : slot.AvailableSlot == "Backup2" ? "B2" : "";
                                        var requestUrl = slot.ShiftId.HasValue
                                            ? $"/shifts/request/{slot.ShiftId}?slot={slot.AvailableSlot}"
                                            : $"/shifts/request/0?date={slot.Date:yyyy-MM-dd}&timeSlotId={slot.TimeSlot.Id}&slot={slot.AvailableSlot}";
                                        var bgClass = isPrimary ? "shift-open" : "shift-assigned";
                                        <a href="@requestUrl" class="d-block text-decoration-none mb-1">
                                            <div class="small p-1 rounded @bgClass" style="font-size: 0.75rem;">
                                                <strong>@slot.TimeSlot.StartTime.ToString("h:mm")</strong>
                                                @if (!isPrimary)
                                                {
                                                    <span class="badge bg-secondary" style="font-size: 0.6rem;">@slotLabel</span>
                                                }
                                            </div>
                                        </a>
                                    }
                                }
                            </td>
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">
        <h4>No Open Shifts</h4>
        <p>All shifts are currently filled. Check back later or contact the office if you'd like to volunteer.</p>
    </div>
}
